# OpenLayers WFST

Tiny WFST-T client to insert (drawing/uploading), modify and delete features on GeoServers using OpenLayers. Layers with these types of geometry are supported: _GeometryCollection_ (in this case, you can choose the geometry type of each element to draw), _Point_, _MultiPoint_, _LineString_, _MultiLineString_, _Polygon_ and _MultiPolygon_.

Tested with OpenLayers version 5 and 6.

<img src="screenshots/example-1.jpg" alt="Drawing" style="width:50%; float:left;">
<img src="screenshots/example-2.jpg" alt="Editing fields" style="width:50%; float:left;">

## Usage

See [Wfst Options](#options) for more details.

```javascript
import 'Wfst' from 'ol-wfst';

// Css
import 'ol-wfst/lib/css/ol-wfst.css';
import 'ol-wfst/lib/css/bootstrap-modal.min.css'; // Do not import if you already have boostrap css

// Optional credentials
const password = 123456;
const username = 'username';

const wfst = new Wfst(map, {
    geoServerUrl: 'https://mysite.com/geoserver/myworkspace/ows',
    headers: { Authorization: 'Basic ' + btoa(username + ':' + password) },
    layers: [
        {
            name: 'myPointsLayer', // Name of the layer on the GeoServer
            label: 'Photos' // Optional Label to be displayed in the controller
        },
        {
            name: 'myMultiGeometryLayer',
            label: 'Other elements'
        }
    ],
    layerMode: 'wfs',
    wfsStrategy: 'bbox',
    language: 'en',
    minZoom: 12,
    showUpload: true,
    beforeInsertFeature: function (feature) {
        // Add a custom value o perform an action before insert features
        feature.set('customProperty', 'customValue', true);
        return feature;
    }
});
```

### Some considerations

-   If the features/vertex appear to be slightly offset after adding them, check the _Number of Decimals_ in your Workplace, you may have to increment that to have a more accurete preview.
-   You can configure a _Basic Authentication_ or an _HTTP Header Proxy Authentication_ with this client, but in some cases is recommended setting that on an reverse proxy on the backend.
-   If you don't use a reverse proxy, remeber configure [cors](https://docs.geoserver.org/latest/en/user/production/container.html#enable-cors)

## Changelog

See [CHANGELOG](./CHANGELOG.md) for details of changes in each release.

## Install
The module uses [modal-vanilla](https://github.com/KaneCohen/modal-vanilla) as a peerDependency to show alerts, forms and messages. The Browser version has been bundled with this.

### Browser

#### JS

Load `ol-wfst.js` after OpenLayers. Wfst is available as `Wfst`.

```HTML
<script src="https://unpkg.com/ol-wfst@1.0.0"></script>
```

#### CSS

```HTML
<link rel="stylesheet" href="https://unpkg.com/ol-wfst@1.0.0/dist/ol-wfst.min.css" />
<link rel="stylesheet" href="https://unpkg.com/ol-wfst@1.0.0/dist/bootstrap-modal.min.css" />
```

### Parcel, Webpack, etc.

NPM package: [ol-wfst](https://www.npmjs.com/package/ol-wfst).

#### JS

Install the package via `npm`

    npm install ol-wfst --save-dev

#### CSS

The CSS files can be found in `./node_modules/ol-wfst/lib`

##### TypeScript type definition

TypeScript types are shipped with the project in the dist directory and should be automatically used in a TypeScript project. Interfaces are provided for Wfst Options.

## API

<!-- Generated by documentation.js. Update this documentation by updating the source code. -->

#### Table of Contents

-   [Wfst](#wfst)
    -   [Parameters](#parameters)
    -   [activateDrawMode](#activatedrawmode)
        -   [Parameters](#parameters-1)
    -   [activateEditMode](#activateeditmode)
        -   [Parameters](#parameters-2)
    -   [insertFeaturesTo](#insertfeaturesto)
        -   [Parameters](#parameters-3)
-   [Options](#options)
    -   [geoServerUrl](#geoserverurl)
    -   [headers](#headers)
    -   [layers](#layers)
    -   [layerMode](#layermode)
    -   [active](#active)
    -   [wfsStrategy](#wfsstrategy)
    -   [evtType](#evttype)
    -   [useLockFeature](#uselockfeature)
    -   [showControl](#showcontrol)
    -   [minZoom](#minzoom)
    -   [language](#language)
    -   [showUpload](#showupload)
    -   [uploadFormats](#uploadformats)
    -   [processUpload](#processupload)
        -   [Parameters](#parameters-4)
    -   [beforeInsertFeature](#beforeinsertfeature)
        -   [Parameters](#parameters-5)
-   [LayerParams](#layerparams)
    -   [name](#name)
    -   [label](#label)
    -   [cql_filter](#cql_filter)
    -   [buffer](#buffer)
-   [i18n](#i18n)

### Wfst

Tiny WFST-T client to insert (drawing/uploading), modify and delete
features on GeoServers using OpenLayers. Layers with these types
of geometry are supported: "GeometryCollection" (in this case, you can
choose the geometry type of each element to draw), "Point", "MultiPoint",
"LineString", "MultiLineString", "Polygon" and "MultiPolygon".

#### Parameters

-   `map` **[PluggableMap](https://openlayers.org/en/latest/apidoc/module-ol_PluggableMap-PluggableMap.html)** Instance of the created map
-   `opt_options` **[Options](#options)?** Wfst options, see [Wfst Options](#options) for more details.

#### activateDrawMode

Activate/deactivate the draw mode

##### Parameters

-   `layerName` **([string](https://developer.mozilla.org/docs/Web/JavaScript/Reference/Global_Objects/String) \| [boolean](https://developer.mozilla.org/docs/Web/JavaScript/Reference/Global_Objects/Boolean))**
-   `geomDrawTypeSelected` **GeometryType** (optional, default `null`)

Returns **void**

#### activateEditMode

Activate/desactivate the edit mode

##### Parameters

-   `bool` (optional, default `true`)

Returns **void**

#### insertFeaturesTo

Add features directly to the geoserver, in a custom layer
without checking geometry or showing modal to confirm.

##### Parameters

-   `layerName` **[string](https://developer.mozilla.org/docs/Web/JavaScript/Reference/Global_Objects/String)**
-   `features` **[Array](https://developer.mozilla.org/docs/Web/JavaScript/Reference/Global_Objects/Array)&lt;Feature>**

Returns **void**

### Options

**_[interface]_** - Wfst Options specified when creating a Wfst instance

Default values:

```javascript
{
 geoServerUrl: null,
 headers: {},
 layers: null,
 layerMode: 'wms',
 evtType: 'singleclick',
 active: true,
 showControl: true,
 useLockFeature: true,
 minZoom: 9,
 language: 'es',
 uploadFormats: '.geojson,.json,.kml',
 processUpload: null,
 beforeInsertFeature: null,
}
```

#### geoServerUrl

Url for OWS services. This endpoint will recive the WFS, WFST and WMS requests

Type: [string](https://developer.mozilla.org/docs/Web/JavaScript/Reference/Global_Objects/String)

#### headers

Url headers for GeoServer requests. You can use it to add Authorization credentials

Type: HeadersInit

#### layers

Layers to be loaded from the geoserver

Type: [Array](https://developer.mozilla.org/docs/Web/JavaScript/Reference/Global_Objects/Array)&lt;[LayerParams](#layerparams)>

#### layerMode

Service to use as base layer. You can choose to use vectors/features or raster images

Type: (`"wfs"` \| `"wms"`)

#### active

Init active

Type: [boolean](https://developer.mozilla.org/docs/Web/JavaScript/Reference/Global_Objects/Boolean)

#### wfsStrategy

Strategy function for loading features. Only works if layerMode is "wfs"

Type: [string](https://developer.mozilla.org/docs/Web/JavaScript/Reference/Global_Objects/String)

#### evtType

Click event to select the features to be edited

Type: (`"singleclick"` \| `"dblclick"`)

#### useLockFeature

Use LockFeatue request on GeoServer when selecting features.
This is not always supportedd by the GeoServer.
See <https://docs.geoserver.org/stable/en/user/services/wfs/reference.html>

Type: [boolean](https://developer.mozilla.org/docs/Web/JavaScript/Reference/Global_Objects/Boolean)

#### showControl

Display the control map

Type: [boolean](https://developer.mozilla.org/docs/Web/JavaScript/Reference/Global_Objects/Boolean)

#### minZoom

Zoom level to hide features to prevent too much features being loaded

Type: [number](https://developer.mozilla.org/docs/Web/JavaScript/Reference/Global_Objects/Number)

#### language

Language to be used

Type: (`"es"` \| `"en"`)

#### showUpload

Show/hide the upload button

Type: [boolean](https://developer.mozilla.org/docs/Web/JavaScript/Reference/Global_Objects/Boolean)

#### uploadFormats

Accepted extension formats on upload.
Example: ".json,.geojson"

Type: [string](https://developer.mozilla.org/docs/Web/JavaScript/Reference/Global_Objects/String)

#### processUpload

Triggered to process the uploaded files.
Use this to apply custom preocces or parse custom formats by filtering the extension.
If this doesn't return features, the default function will be used to extract the features.

##### Parameters

-   `file` **File**

Returns **[Array](https://developer.mozilla.org/docs/Web/JavaScript/Reference/Global_Objects/Array)&lt;Feature>**

#### beforeInsertFeature

Triggered before insert new features to the Geoserver.
Use this to insert custom properties, modify the feature, etc.

##### Parameters

-   `feature` **Feature**

Returns **Feature**

### LayerParams

**_[interface]_** - Parameters to create an load the GeoServer layers

#### name

Layer name in the GeoServer

Type: [string](https://developer.mozilla.org/docs/Web/JavaScript/Reference/Global_Objects/String)

#### label

Label to be displayed in the controller

Type: [string](https://developer.mozilla.org/docs/Web/JavaScript/Reference/Global_Objects/String)

#### cql_filter

The cql_filter parameter is similar to the standard filter parameter,
but the filter is expressed using ECQL (Extended Common Query Language).
ECQL provides a more compact and readable syntax compared to OGC XML filters.
For full details see the [ECQL Reference](https://docs.geoserver.org/stable/en/user/filter/ecql_reference.html#filter-ecql-reference) and CQL and ECQL tutorial.

Type: [string](https://developer.mozilla.org/docs/Web/JavaScript/Reference/Global_Objects/String)

#### buffer

The buffer parameter specifies the number of additional
border pixels that are used in the GetMap and GetFeatureInfo operations.

Type: [number](https://developer.mozilla.org/docs/Web/JavaScript/Reference/Global_Objects/Number)

### i18n

**_[interface]_** - Custom Language specified when creating a WFST instance

## TODO

-   Add diferents layer styles
-   Improve widget controller: visibility toggle
-   Geometry type _LinearRing_ support
-   Tests!

## License

MIT (c) Gastón Zalba.
